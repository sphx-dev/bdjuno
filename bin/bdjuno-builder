#!/bin/bash

set -e
echo "hey"
# go to root dir of repository
pushd "$(dirname "${BASH_SOURCE[0]}")/.." > /dev/null

VERSION=$(git rev-parse --short HEAD)
REPO=$(pwd)
BUILD_BIN="$REPO/bin/.cache/build-$VERSION"
echo "BUILD_BIN:"
echo $BUILD_BIN

if [ ! -f "$BUILD_BIN" ]; then
  rm -f ./bin/.cache/build-*
  
  pushd build > /dev/null
  echo "PRE"
  go build -trimpath -o "$BUILD_BIN" ./cmd/builder
  echo "POST"
  popd > /dev/null

  "$BUILD_BIN" build/me
fi
echo "got hereA"
case "$1" in
   "znet")
      echo "got here"
      MODULE="github.com/CoreumFoundation/crust"
      VERSION_TMPL='{{ if or (.Replace) (eq .Version "") }}devel{{ else }}{{ .Version }}{{ end }}'
      ZNET_VERSION=`go list -m -f "$VERSION_TMPL" "$MODULE"`
      ZNET_BIN="$REPO/bin/.cache/znet-${ZNET_VERSION}"
      
      if [ ! -f "$ZNET_BIN" ]; then
        "$BUILD_BIN" build/znet
      fi

      shift 1
      exec "$ZNET_BIN" "$@"
      ;;

   *)
     echo "got here - exec"
     exec "$BUILD_BIN" "$@"
     ;;
esac
echo "Builder finished"
